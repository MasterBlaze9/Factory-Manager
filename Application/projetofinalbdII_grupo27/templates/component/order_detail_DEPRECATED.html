{% extends 'base.html' %} {% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center border-bottom"
>
  <h2>{{ order_data.1 }}</h2>
  <h2 class="float-end">
    Encomendado a: {{ order_data.3|date:'d-m-Y'|default:"-" }}
  </h2>
</div>
{% if error_message %}
<div class="mt-3 mb-3">
  <h6 class="text-danger">{{ error_message }}</h6>
</div>
{% endif %}
<div class="pt-md-3">
  <div>
    <form
      action="{% url 'order_register_delivery' %}"
      method="POST"
      onsubmit="return getSelectedComponents()"
    >
      {% csrf_token %}
      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center"
      >
        <h3>Componentes encomendados</h3>
        <div class="mb-3">
          {% comment %} {% if components_to_deliver %}
          <a
            id="btnRegisterComponentDelivery"
            class="btn btn-primary mb-3 float-end"
            data-bs-toggle="modal"
            data-bs-target="#registerComponentDeliveryModal"
            >Registar receção de componentes</a
          >
          {% endif %} {% endcomment %}
          <button
            id="btn-register-components-delivery"
            class="btn btn-success d-none"
            type="submit"
          >
            Registar receção de componentes
          </button>
        </div>
      </div>
      <input
        id="selected_components"
        name="selected_components"
        type="hidden"
      />
      <table
        id="table-order-components"
        class="table table-striped"
        style="width: 100%"
      >
        <thead>
          <tr>
            <th class="no-sort"></th>
            <th>Componente</th>
            <th>Quantidade encomendada</th>
            <th>Quantidade recebida</th>
            <th>Preço unitário</th>
            <th>Preço total</th>
            <th>Fornecedor</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for row in order_components_data %}
          <tr>
            <td>
              {% if row.8 != 'Entregue' %}
              <input
                type="checkbox"
                name="selected_items"
                value="{{ row.10 }}"
              />
              {% endif %}
            </td>
            <td>{{ row.1.strip|default:"-" }}</td>
            <td>{{ row.2|default:"-" }}</td>
            <td>{{ row.3|default:"-" }}</td>
            <td>{{ row.4|default:"-" }}€</td>
            <td>{{ row.5|default:"-" }}€</td>
            <td>{{ row.7.strip|default:"-" }}</td>
            {% if row.8 == 'Por entregar' %}
            <td class="text-danger">{{ row.8.strip|default:"-" }}</td>
            {% elif row.8 == 'Parcialmente entregue' %}
            <td class="text-warning">{{ row.8.strip|default:"-" }}</td>
            {% else %}
            <td class="text-success">{{ row.8.strip|default:"-" }}</td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>
  </div>

  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mt-3"
  >
    <h3>Faturas</h3>
  </div>
  <table
    id="table-order-invoices"
    class="table table-striped"
    style="width: 100%"
  >
    <thead>
      <tr>
        <th>Fatura</th>
        <th>Data da fatura</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for row in order_invoices_data %}
      <tr>
        <td>{{ row.1.strip|default:"-" }}</td>
        <td>{{ row.2|date:'d-m-Y'|default:"-" }}</td>
        <td>
          <a
            id="btnSeeInvoiceDetails"
            class="btn btn-primary"
            onclick="getOrderInvoiceDetails({{ row.0 }})"
            >Visualizar detalhes</a
          >
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Modals -->
  <div
    class="modal modal-lg fade"
    id="registerComponentDeliveryModal"
    tabindex="-1"
    aria-labelledby="registerComponentDeliveryModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerComponentDeliveryModalLabel">
            Registar receção de componentes
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <form
          method="post"
          action="{% url 'registerOrderComponentDelivery' %}"
          enctype="multipart/form-data"
        >
          <div class="modal-body">
            <div class="">
              {% csrf_token %}
              <input
                type="hidden"
                id="order_id"
                name="order_id"
                value="{{ order_data.0 }}"
              />
              <div class="col-12">
                <label for="selectOrderComponent">Componente</label>
                <select
                  id="selectOrderComponent"
                  name="selectOrderComponent"
                  class="form-select"
                  aria-label="Selecionar componente"
                  onchange="getSuppliersBySelectedComponent()"
                  required
                >
                  <option value="" selected>Selecione componente</option>
                  {% for row in components_to_deliver %}
                  <option
                    value="{{ row.order_component_id }}"
                    data-quantity-left-to-order="{{ row.quantity_left_to_order }}"
                  >
                    {{ row.component_designation }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="row mt-3 d-none remove-d-none">
                <div class="col-6">
                  <label for="deliveredQuantity">Quantidade recebida</label>
                  <input
                    type="number"
                    id="deliveredQuantity"
                    name="deliveredQuantity"
                    class="form-control"
                    placeholder="Quantidade"
                    min="1"
                    required
                  />
                </div>
                <div class="col-6">
                  <label for="deliveredDate">Data da entrega</label>
                  <input
                    type="date"
                    id="deliveredDate"
                    name="deliveredDate"
                    class="form-control"
                    placeholder="Data da entrega"
                    required
                  />
                </div>
              </div>
              <div class="row mt-3 d-none remove-d-none">
                <div class="col-6">
                  <label for="selectWarehouse">Armazém</label>
                  <select
                    id="selectWarehouse"
                    name="selectWarehouse"
                    class="form-select"
                    aria-label="Selecionar armazém"
                    required
                  >
                    <option value="" selected disabled>
                      Selecione armazém
                    </option>
                    {% for row in warehouses_data %}
                    <option value="{{ row.0 }}">{{ row.1 }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-6"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <input
              id="btnSaveRegisterOrderComponentDelivery"
              class="btn btn-success float-end"
              type="submit"
              value="Guardar"
            />
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div
    class="modal modal-lg fade"
    id="invoiceDetailsModal"
    tabindex="-1"
    aria-labelledby="invoiceDetailsModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="invoiceDetailsModalLabel"></h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div id="invoiceDetailsModalBody" class="modal-body">
          <div class="row">
            <div class="col-6">
              <label for="invoiceDetails_invoicedate">Data da fatura</label>
              <div>
                <span id="invoiceDetails_invoicedate"></span>
              </div>
            </div>
            <div class="col-6">
              <label for="invoiceDetails_order">Encomenda</label>
              <div>
                <span id="invoiceDetails_order"></span>
              </div>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-6">
              <label for="invoiceDetails_component">Componente</label>
              <div>
                <span id="invoiceDetails_component"></span>
              </div>
            </div>
            <div class="col-6">
              <label for="invoiceDetails_supplier">Fornecedor</label>
              <div>
                <span id="invoiceDetails_supplier"></span>
              </div>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-6">
              <label for="invoiceDetails_deliveredQuantity"
                >Quantidade entregue</label
              >
              <div>
                <span id="invoiceDetails_deliveredQuantity"></span>
              </div>
            </div>
            <div class="col-6">
              <label for="invoiceDetails_unitPrice">Preço unitário</label>
              <div>
                <span id="invoiceDetails_unitPrice"></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  $(document).ready(function () {
    $("#table-order-components").DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-PT.json"
      },
      columnDefs: [
        {
          targets: "no-sort",
          orderable: false
        }
      ]
    });

    $("#table-order-invoices").DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-PT.json"
      },
      columnDefs: [
        {
          targets: "no-sort",
          orderable: false
        }
      ]
    });
  });

  const checkboxes = document.querySelectorAll(
    'input[type="checkbox"][name="selected_items"]'
  );

  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", checkIfAnySelected);
  });

  window.addEventListener("DOMContentLoaded", checkIfAnySelected);
  function checkIfAnySelected() {
    const checkboxes = document.querySelectorAll(
      'input[type="checkbox"][name="selected_items"]'
    );

    let isChecked = false;
    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        isChecked = true;
      }
    });

    isChecked
      ? document
          .getElementById("btn-register-components-delivery")
          .classList.remove("d-none")
      : document
          .getElementById("btn-register-components-delivery")
          .classList.add("d-none");

    return isChecked;
  }

  function getSelectedComponents() {
    const checkboxes = document.querySelectorAll(
      'input[type="checkbox"][name="selected_items"]'
    );

    let selectedComponents = [];
    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        selectedComponents.push(checkbox.value);
      }
    });

    document.getElementById("selected_components").value = selectedComponents;
  }

  function getSuppliersBySelectedComponent() {
    var order_component_id = $("#selectOrderComponent").val();
    var quantity_left_to_order = $(
      "#selectOrderComponent option:selected"
    ).data("quantity-left-to-order");

    var deliveredQuantity = document.getElementById("deliveredQuantity");
    deliveredQuantity.setAttribute("max", quantity_left_to_order);

    var elementsToShow = document.getElementsByClassName("remove-d-none");
    for (var i = 0; i < elementsToShow.length; i++) {
      elementsToShow[i].classList.remove("d-none");
    }
  }

  function getOrderInvoiceDetails(orderinvoice_id) {
    $.ajax({
      url: "/component/getOrderInvoiceDetails/",
      type: "GET",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      },
      data: {
        orderinvoice_id: orderinvoice_id
      },
      success: function (data) {
        data = JSON.parse(data);

        document.getElementById("invoiceDetailsModalLabel").innerHTML =
          "Detalhes da fatura - " + data[1];
        document.getElementById("invoiceDetails_invoicedate").innerHTML =
          data[2];
        document.getElementById("invoiceDetails_order").innerHTML = data[4];
        document.getElementById("invoiceDetails_component").innerHTML = data[7];
        document.getElementById("invoiceDetails_supplier").innerHTML = data[9];
        document.getElementById("invoiceDetails_deliveredQuantity").innerHTML =
          data[10];
        document.getElementById("invoiceDetails_unitPrice").innerHTML =
          data[11] + "€";

        $("#invoiceDetailsModal").modal("show");
      },
      error: function (error) {
        console.log(error);
      }
    });
  }
</script>
{% endblock %}
