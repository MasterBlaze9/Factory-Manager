{% extends 'base.html' %} {% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center border-bottom"
>
  <input type="hidden" id="order_id" value="{{ order_data.0 }}" />
  <h2>{{ order_data.1 }}</h2>
  <h2 class="float-end">
    Encomendado a: {{ order_data.3|date:'d-m-Y'|default:"-" }}
  </h2>
</div>
{% if error_message %}
<div class="mt-3 mb-3">
  <h6 class="text-danger">{{ error_message }}</h6>
</div>
{% endif %}
<div class="pt-md-3">
  <div>
    <form
      action="{% url 'order_register_delivery' %}"
      method="POST"
      onsubmit="return getSelectedComponents()"
    >
      {% csrf_token %}
      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center"
      >
        <h3>Componentes encomendados</h3>
        <div class="mb-3">
          <button
            id="btn-register-components-delivery"
            class="btn btn-success d-none"
            type="submit"
          >
            Registar receção de componentes
          </button>
        </div>
      </div>
      <input
        id="selected_components"
        name="selected_components"
        type="hidden"
      />
      <table
        id="table-order-components"
        class="table table-striped"
        style="width: 100%"
      >
        <thead>
          <tr>
            <th class="no-sort"></th>
            <th>Componente</th>
            <th>Quantidade encomendada</th>
            <th>Quantidade recebida</th>
            <th>Preço unitário</th>
            <th>Preço total</th>
            <th>Fornecedor</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for row in order_components_data %}
          <tr>
            <td>
              {% if row.9 != 'Entregue' %}
              <input
                type="checkbox"
                name="selected_items"
                value="{{ row.11 }}"
              />
              {% endif %}
            </td>
            <td>{{ row.1.strip|default:"-" }}</td>
            <td>{{ row.2|default:"-" }}</td>
            <td>{{ row.3|default:"-" }}</td>
            <td>{{ row.5|default:"-" }}€</td>
            <td>{{ row.6|default:"-" }}€</td>
            <td>{{ row.8.strip|default:"-" }}</td>
            {% if row.9 == 'Por entregar' %}
            <td class="text-danger">{{ row.9.strip|default:"-" }}</td>
            {% elif row.9 == 'Parcialmente entregue' %}
            <td class="text-warning">{{ row.9.strip|default:"-" }}</td>
            {% else %}
            <td class="text-success">{{ row.9.strip|default:"-" }}</td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>
  </div>

  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mt-3"
  >
    <h3>Faturas</h3>
  </div>
  <table
    id="table-order-invoices"
    class="table table-striped"
    style="width: 100%"
  >
    <thead>
      <tr>
        <th>Fatura</th>
        <th>Data da fatura</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for row in order_invoices_data %}
      <tr>
        <td>{{ row.1.strip|default:"-" }}</td>
        <td>{{ row.2|date:'d-m-Y'|default:"-" }}</td>
        <td>
          <a
            id="btnSeeInvoiceDetails"
            class="btn btn-primary"
            onclick="getOrderInvoiceDetails({{ row.0 }}, '{{ row.1 }}')"
            >Visualizar detalhes</a
          >
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Modals -->
  <div
    class="modal modal-xl fade"
    id="invoiceDetailsModal"
    tabindex="-1"
    aria-labelledby="invoiceDetailsModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="invoiceDetailsModalLabel"></h3>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div id="invoiceDetailsModalBody" class="modal-body">
          <table
            id="table-order-invoice-details"
            class="table table-striped"
            style="width: 100%"
          >
            <thead>
              <tr>
                <th>Componente</th>
                <th>Fornecedor</th>
                <th>Quantidade entregue</th>
                <th>Entregue a</th>
                <th>Local de armazenamento</th>
              </tr>
            </thead>
            <tbody id="table-order-invoice-details-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  $(document).ready(function () {
    $("#table-order-components").DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-PT.json"
      },
      columnDefs: [
        {
          targets: "no-sort",
          orderable: false
        }
      ]
    });

    $("#table-order-invoices").DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-PT.json"
      },
      columnDefs: [
        {
          targets: "no-sort",
          orderable: false
        }
      ]
    });
  });

  const checkboxes = document.querySelectorAll(
    'input[type="checkbox"][name="selected_items"]'
  );

  checkboxes.forEach((checkbox) => {
    checkbox.addEventListener("change", checkIfAnySelected);
  });

  window.addEventListener("DOMContentLoaded", checkIfAnySelected);
  function checkIfAnySelected() {
    const checkboxes = document.querySelectorAll(
      'input[type="checkbox"][name="selected_items"]'
    );

    let isChecked = false;
    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        isChecked = true;
      }
    });

    isChecked
      ? document
          .getElementById("btn-register-components-delivery")
          .classList.remove("d-none")
      : document
          .getElementById("btn-register-components-delivery")
          .classList.add("d-none");

    return isChecked;
  }

  function getSelectedComponents() {
    const checkboxes = document.querySelectorAll(
      'input[type="checkbox"][name="selected_items"]'
    );

    let selectedComponents = [];
    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        selectedComponents.push(checkbox.value);
      }
    });

    document.getElementById("selected_components").value = selectedComponents;
  }

  function getOrderInvoiceDetails(orderinvoice_id, invoice_number) {
    $.ajax({
      url: "/component/getOrderInvoiceDetails/",
      type: "GET",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}"
      },
      data: {
        order_id: document.getElementById("order_id").value,
        orderinvoice_id: orderinvoice_id
      },
      success: function (data) {
        data = JSON.parse(data);
        document.getElementById("invoiceDetailsModalLabel").innerHTML =
          invoice_number;

        const tableBody = document.getElementById(
          "table-order-invoice-details-tbody"
        );
        tableBody.innerHTML = "";

        var values_positions = [5, 7, 10, 11, 9];
        data.forEach((item) => {
          const row = document.createElement("tr");
          for (let i = 0; i < values_positions.length; i++) {
            const column = document.createElement("td");
            column.textContent = item[`${values_positions[i]}`];
            row.appendChild(column);
          }

          tableBody.appendChild(row);
        });

        $("#invoiceDetailsModal").modal("show");
      },
      error: function (error) {
        console.log(error);
      }
    });
  }
</script>
{% endblock %}
